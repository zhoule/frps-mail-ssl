# FRPS + SSL 系统架构图

## 🏗️ 整体架构图

```
                                    Internet
                                       │
                                       │ Port 80/443
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                               Nginx Proxy                                   │
│                           (SSL Termination)                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │   Let's Encrypt │  │  SSL Certs      │  │  Domain Config  │              │
│  │   Auto Renewal  │  │  Storage        │  │  Generator      │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
│                                                                             │
│  HTTPS Proxy Rules:                                                         │
│  • frps.domain.com → frps:8880 (HTTP Tunnel)                              │
│  • admin-frps.domain.com → frps:7001 (Dashboard)                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                           │              │
                           │              │
                           ▼              ▼
┌─────────────────────────────┐  ┌─────────────────┐
│         FRPS Server         │  │   FRPS Admin    │
│                             │  │   Dashboard     │
├─────────────────────────────┤  ├─────────────────┤
│                             │  │                 │
│ Port 7000: Main Service     │  │ Port 7001: Web  │
│ Port 8880: HTTP Proxy       │  │ Management UI   │
│ Port 8843: HTTPS Proxy      │  │                 │
│                             │  │ Features:       │
│ Features:                   │  │ • Tunnel Status │
│ • TCP Multiplexing          │  │ • Client Config │
│ • Connection Pool           │  │ • Statistics    │
│ • Domain Routing            │  │ • User Mgmt     │
│ • Load Balancing            │  │                 │
│                             │  │                 │
└─────────────────────────────┘  └─────────────────┘
                           │
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Client Connections                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐              │
│  │   FRPS Client   │  │   Web Browser   │              │
│  │                 │  │                 │              │
│  │ • Home Network  │  │ • Admin Panel   │              │
│  │ • Office LAN    │  │ • Tunnel Mgmt   │              │
│  │ • IoT Devices   │  │ • Service Mgmt  │              │
│  │ • Servers       │  │                 │              │
│  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🔄 数据流向图

```
┌─────────────────┐    HTTPS     ┌─────────────────┐    HTTP      ┌─────────────────┐
│                 │ ─────────────▶│                 │ ─────────────▶│                 │
│   Web Browser   │              │  Nginx Proxy    │              │  FRPS Server    │
│                 │◀───────────── │                 │◀───────────── │                 │
└─────────────────┘              └─────────────────┘              └─────────────────┘

┌─────────────────┐     TCP      ┌─────────────────┐    Tunnel    ┌─────────────────┐
│                 │ ─────────────▶│                 │ ─────────────▶│                 │
│  FRPS Client    │              │  FRPS Server    │              │ Internal Apps   │
│                 │◀───────────── │                 │◀───────────── │                 │
└─────────────────┘              └─────────────────┘              └─────────────────┘
```

## 🚀 部署流程图

```
                            [开始部署]
                                 │
                                 ▼
                        ┌─────────────────┐
                        │  检查系统依赖    │
                        │ • Docker        │
                        │ • Docker Compose│
                        │ • OpenSSL       │
                        └─────────────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │  初始化环境      │
                        │ • 创建目录结构   │
                        │ • 生成基础配置   │
                        └─────────────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │ 生成服务配置     │
                        │ • FRPS配置      │
                        │ • Nginx配置     │
                        └─────────────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │  启动基础服务    │
                        │ • Nginx         │
                        │ • FRPS          │
                        └─────────────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │  配置域名SSL     │
                        │ • 生成域名配置   │
                        │ • 申请SSL证书   │
                        │ • 更新Nginx配置 │
                        └─────────────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │  重启服务应用    │
                        │  SSL配置        │
                        └─────────────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │  部署完成        │
                        │ • 服务验证      │
                        │ • 显示访问信息   │
                        └─────────────────┘
```

## 🔧 端口映射图

```
                          主机端口              容器端口
                       ┌─────────────┐      ┌─────────────┐
Internet :80    ────── │   80        │ ──── │   80        │ Nginx
Internet :443   ────── │   443       │ ──── │   443       │ Nginx
                       └─────────────┘      └─────────────┘

                       ┌─────────────┐      ┌─────────────┐
FRPS Clients:7000 ──── │   7000      │ ──── │   7000      │ FRPS Server
                       └─────────────┘      └─────────────┘

内部通信端口 (仅容器间):
FRPS HTTP Proxy  : 8880
FRPS HTTPS Proxy : 8843  
FRPS Dashboard   : 7001
```

## 📁 目录结构图

```
frps-ssl-deploy/
├── 📄 deploy.sh                    # 主部署脚本
├── 📄 docker-compose.yml           # Docker编排文件
├── 📄 README.md                    # 详细文档
├── 📄 architecture.md              # 架构说明(本文件)
│
├── 📁 nginx/                       # Nginx配置
│   ├── 📁 conf/
│   │   ├── 📄 nginx.conf          # 主配置
│   │   └── 📁 conf.d/             # 域名配置目录
│   │       ├── 📄 default.conf    # 默认配置
│   │       ├── 📄 frps.domain.conf # FRPS域名配置
│   │       └── 📄 admin.domain.conf# 管理界面配置
│   └── 📁 html/                   # Web根目录
│       └── 📄 index.html          # 欢迎页面
│
├── 📁 frps/                       # FRPS配置
│   └── 📁 config/
│       └── 📄 frps.toml           # FRPS服务器配置
│
├── 📁 certbot/                    # SSL证书
│   └── 📁 data/                   # Let's Encrypt证书存储
│       └── 📁 live/               # 活跃证书目录
│           ├── 📁 domain1.com/    # 域名1证书
│           ├── 📁 domain2.com/    # 域名2证书
│           └── 📁 domain3.com/    # 域名3证书
│
└── 📁 logs/                       # 系统日志
    ├── 📄 deploy.log              # 部署日志
    ├── 📄 ssl-renew.log           # 证书续签日志
    ├── 📁 nginx/                  # Nginx日志
    │   ├── 📄 access.log          # 访问日志
    │   ├── 📄 error.log           # 错误日志
    │   ├── 📄 domain1.access.log  # 域名1访问日志
    │   └── 📄 domain1.error.log   # 域名1错误日志
    └── 📁 frps/                   # FRPS日志
        └── 📄 frps.log            # FRPS服务日志
```

## 🔐 SSL证书管理流程

```
                    [证书申请流程]
                          │
                          ▼
                 ┌─────────────────┐
                 │  检查域名解析    │
                 │  A记录是否指向   │
                 │  当前服务器      │
                 └─────────────────┘
                          │
                          ▼
                 ┌─────────────────┐
                 │  启动HTTP服务    │
                 │  用于ACME验证    │
                 └─────────────────┘
                          │
                          ▼
                 ┌─────────────────┐
                 │  调用Certbot     │
                 │  申请证书        │
                 └─────────────────┘
                          │
                          ▼
                 ┌─────────────────┐      ┌─────────────────┐
                 │  验证成功        │ ──── │  证书存储到      │
                 │  证书颁发        │      │  certbot/data/  │
                 └─────────────────┘      └─────────────────┘
                          │
                          ▼
                 ┌─────────────────┐
                 │  更新Nginx配置   │
                 │  启用HTTPS       │
                 └─────────────────┘
                          │
                          ▼
                 ┌─────────────────┐
                 │  重启Nginx       │
                 │  应用新配置      │
                 └─────────────────┘

                    [自动续签流程]
                          │
                          ▼
                 ┌─────────────────┐
                 │  Cron任务触发    │
                 │  (每周日2点)     │
                 └─────────────────┘
                          │
                          ▼
                 ┌─────────────────┐
                 │  检查证书到期    │
                 │  时间(<30天)     │
                 └─────────────────┘
                          │
                          ▼
                 ┌─────────────────┐
                 │  自动续签证书    │
                 │  无需停机        │
                 └─────────────────┘
                          │
                          ▼
                 ┌─────────────────┐
                 │  重新加载Nginx   │
                 │  应用新证书      │
                 └─────────────────┘
```

## 🌐 网络拓扑图

```
                              Internet
                                 │
                                 │
                          ┌─────────────┐
                          │   Firewall  │
                          │   Port 80   │
                          │   Port 443  │
                          │   Port 7000 │
                          └─────────────┘
                                 │
                                 │
                    ┌─────────────────────────────┐
                    │        Docker Host          │
                    │                             │
                    │  ┌───────────────────────┐  │
                    │  │   Docker Network      │  │
                    │  │   (app-network)       │  │
                    │  │   172.30.0.0/16       │  │
                    │  │                       │  │
                    │  │  ┌─────┐ ┌─────┐ │  │
                    │  │  │Nginx│ │FRPS │ │  │
                    │  │  │Proxy│ │Server│ │  │
                    │  │  └─────┘ └─────┘ │  │
                    │  └───────────────────────┘  │
                    └─────────────────────────────┘
```

## 📊 监控视图

```
                        [系统监控面板]
                               │
           ┌───────────────────┼───────────────────┐
           │                   │                   │
           ▼                   ▼                   ▼
  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
  │   服务状态       │ │   SSL证书       │ │   性能指标      │
  │                │ │                 │ │                 │
  │ ✅ Nginx: 运行   │ │ 🔒 domain1.com  │ │ 📈 CPU: 15%     │
  │ ✅ FRPS: 运行    │ │    90天有效     │ │ 💾 内存: 1.2GB  │
  │                │ │ 🔒 domain2.com  │ │ 💿 磁盘: 45%    │
  │ 🔄 自动续签: 开启 │ │    85天有效     │ │ 🌐 网络: 正常   │
  │                │ │                 │ │ 🚀 隧道: 3个    │
  └─────────────────┘ └─────────────────┘ └─────────────────┘
           │                   │                   │
           └───────────────────┼───────────────────┘
                               │
                               ▼
                    ┌─────────────────┐
                    │   告警通知       │
                    │                │
                    │ 📧 邮件通知      │
                    │ 📱 短信告警      │
                    │ 🔔 系统日志      │
                    └─────────────────┘
```

这个架构图详细展示了FRPS + SSL系统的组件关系、数据流向、部署流程和监控方案，让部署和运维更加清晰明了！